// https://github.com/yanglindayang/thread // Copyright (c) 2012 Yang Linda Yang / http://yanglindayang.com / yanglindayang@gmail.com // GPL Licensed

(function(h,i){function j(a,b){this.element=a;this.options=h.extend({},k,b);this._defaults=k;this._name=f;this.init()}var f="thread",k={blocks:null,gridClass:f+"-grid",blockClass:f+"-block",columnClass:f+"-column",layout:{columnNumber:{"mobile-vertical":1,"mobile-horizontal":1,ereader:1,"tablet-vertical":1,"tablet-horizontal":1,desktop:2,"desktop-large":3},gutter:"4%"},duration:300,onInitial:function(){},onOneLoad:function(){},onAllLoad:function(){}},m=0;j.prototype={init:function(){var a=this,b=
jQuery("<div/>").addClass(this.options.gridClass).css({position:"relative"});this.$grid=jQuery(this.element).wrap(b);this.$blocks=[];null!==this.options.blocks?(this.$blocks=this.options.blocks,this.type="dynamic"):(jQuery(this.element).hide(),this.$blocks=jQuery(this.element).children(),this.type="static");this.blockNumber=this.$blocks.length;this.calculateGrid("initial").createColumns(this.columnNumber).renderBlock(0,this.columnNumber);jQuery(i).resize(function(){var b=a.columnNumber,d=a.calculateGrid(),
c=d.columnNumber;if(b!=c)i.location.reload();else{b=d.$columns;b.each(function(){jQuery(this).children().each(function(a){a>=c&&jQuery(this).css({marginTop:d.gutter})})});if(c>1){var g=[];b.each(function(a){var b=jQuery(this).children().eq(0),c=jQuery(this).children().last(),c=c.position().top+c.outerHeight(true);g.push(c);jQuery(this).css({height:c,width:d.columnWidth,left:d.columnWidth*a+d.gutter*a});b.css({marginTop:0})});d.$grid.height(Math.max.apply(null,g))}}})},renderBlock:function(a,b){if(a<
this.blockNumber){var e=this,d=0;a>=this.columnNumber&&(d=this.gutter);var c=jQuery(this.$blocks[a]).attr("id",this._defaults.blockClass+"-"+(a+1)).addClass(this._defaults.blockClass).css({margin:0,padding:0,width:"100%",marginTop:d}),g=c.find("img"),f=g.length,h=this.minColumn,i=jQuery(h),j,l=this.options.duration,k=function(){j=c.outerHeight()+d;b>1&&e.calculateShortest(j,i);e.options.onOneLoad(c);e.renderBlock(a+1,b)};0===a&&e.$grid.fadeIn();c.appendTo(h).hide();0<f&&"dynamic"==this.type?(c.delay(l*
a).fadeIn(l),g.on("load",k)):(c.delay(l*a).fadeIn(l),k());m++}else if(a==this.blockNumber)this.options.onAllLoad()},analyzeUnits:function(a,b){var e=a.toString();return-1<e.search("px")||-1<e.search("em")?a:parseFloat(a)/100*b},createColumns:function(a){var b,e=this.columnWidth,d=this.gutter,c=this.options.columnClass;for(b=0;b<a;b++){var g=jQuery("<div></div>").attr("id",c+"-"+(b+1)).addClass(c);1<a&&g.css({position:"absolute",width:e,left:e*b+d*b});this.$grid.append(g)}this.$columns=jQuery("."+
this.options.columnClass);1<a?this.calculateShortest():this.minColumn=this.$columns[0];return this},calculateShortest:function(a,b){b&&b.height(a+b.height());var e=this.$columns,d=[],d=e.map(function(a,b){return jQuery(b).height()});this.minColumn=e.map(function(a,b){if(jQuery(b).height()==Math.min.apply(null,d))return b})[0];this.maxColumn=e.map(function(a,b){if(jQuery(b).height()==Math.max.apply(null,d))return b})[0];this.$grid.height(jQuery(this.maxColumn).height())},calculateGrid:function(a){this.windowWidth=
jQuery(i).width();this.gridWidth=this.$grid.innerWidth();this.gutter=this.analyzeUnits(this.options.layout.gutter,this.gridWidth);360>=this.windowWidth?this.layout="mobile-vertical":480>=this.windowWidth&&360<this.windowWidth?this.layout="mobile-horizontal":768>=this.windowWidth&&480<this.windowWidth?this.layout="ereader":980>=this.windowWidth&&768<this.windowWidth?this.layout="tablet-vertical":1024>=this.windowWidth&&980<this.windowWidth?this.layout="tablet-horizontal":1200>=this.windowWidth&&1024<
this.windowWidth?this.layout="desktop":1200<this.windowWidth&&(this.layout="desktop-large");this.columnNumber=this.options.layout.columnNumber[this.layout];this.columnWidth=(this.gridWidth-(this.columnNumber-1)*this.gutter)/this.columnNumber;"static"==this.type&&"initial"==a&&this.$blocks.hide();return this}};h.fn[f]=function(a){return this.each(function(){h.data(this,"plugin_"+f)||h.data(this,"plugin_"+f,new j(this,a))})}})(jQuery,window,document);